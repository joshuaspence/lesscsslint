#!/usr/bin/env node

var _ = require('lodash'),
    commander = require('commander'),
    csslint = require('csslint').CSSLint,
    fs = require('fs'),
    less = require('less'),
    path = require('path'),
    SourceMapConsumer = require('source-map').SourceMapConsumer;

var lessOptions = {
    compress: false,
    cleancss: false,
    optimization: null,
    paths: []
};

var parseLessFile = function(err, data) {
    if (err) {
        console.error(err);
        return;
    }

    lessOptions.paths = [path.dirname(input)].concat(lessOptions.paths);
    lessOptions.filename = input;

    var smc;

    var parser = new(less.Parser)(lessOptions);
    parser.parse(data, function(err, tree) {
        if (err) {
            console.error(err);
            return;
        } else {
            var css = tree.toCSS(_.extend(lessOptions, {
                sourceMap: true,
                writeSourceMap: function(sourceMap) {
                    smc = new SourceMapConsumer(sourceMap);
                }
            }));

            var ruleset = {};
            csslint.getRules().forEach(function(rule) {
                ruleset[rule.id] = 1;
            });

            results = csslint.verify(css, ruleset);

            results.messages = _(results.messages).filter(function(message) {
                var position = smc.originalPositionFor({
                    line: message.line,
                    column: message.col
                });

                if (position.source !== input) {
                    return false;
                }

                message.line = position.line;
                message.column = position.column;
                return true;
            });

            var formatter = csslint.getFormatter('compact');
            console.log(formatter.formatResults(results, ''));
        }
    });
};

commander
    .version(require('../package.json').version)
    .usage('[options] <source-map>')
    .parse(process.argv);

var input = commander.args[0];
if (!input) {
  console.error('No input');
  process.exit(1);
} else if (input !== '-') {
    input = path.resolve(process.cwd(), input);
}

if (input !== '-') {
    fs.readFile(input, 'utf8', parseLessFile);
} else {
    process.stdin.resume();
    process.stdin.setEncoding('utf8');

    var buffer = '';
    process.stdin.on('data', function(data) {
        buffer += data;
    });

    process.stdin.on('end', function() {
        parseLessFile(false, buffer);
    });
}
